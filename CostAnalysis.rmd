---

title: "Cost Analysis"
date: "02/06/2015"
output:
    html_document:
        toc: true
        toc_depth: 4
        number_sections: true
---




#Cost Analysis


```{r,echo=F,results='hide', warning=F}

source("LoadData.R")
source("./SmallScripts/Utility.r")
library("ggplot2")
library("xtable")
library("GGally")
library("scales")
library("reshape")
library("plyr")

```

```{r,results='asis'}

#source("./SmallScripts/CleanCosts.r")

PublicFac  <- c("PH","DH","HC")

```

## OutPatient

### Check Number of Out Patient Records
```{r,results='html'}

##Check the total number of OutPatient Events
sum(OutPat$Q==1)

##Check the total number of OutPatient Events
sapply(OutPatGroups,sum)

```

### Plot Outpatient Totals By Facility
```{r ,echo=F, results='asis'}

p <- ggplot(data=OutPat)
p <- p + geom_point(aes(x=Facility,y=Total,color=Group),
                    position=position_jitter(w=.2,h=0),
                    alpha=.35)
print(p)


p <- p + coord_cartesian(ylim = c(0, 750000))
print(p)

```

### Plot Outpatient Totals By Facility with group
```{r ,echo=F, results='asis'}

p <- p + facet_grid(Group~.)
print(p)

p <- p + coord_cartesian(ylim = c(0, 50000))
print(p)

```

### Plot Outpatient Costs by Cost Type, Srvice, and Group
```{r ,echo=F, results='asis'}

OutPCostBreakDown <-  melt(data=OutPat[,c("Medical_Fee","Medicine","Others","Transport","Total","Serial","Facility","Group")],id.vars=c("Serial","Facility","Group"))
OutPCostBreakDown <- subset(OutPCostBreakDown,!is.na(value))

p <- ggplot(data=OutPCostBreakDown)
p <- p + geom_point(aes(x=variable,y=value))
p <- p + facet_grid(Group~Facility)
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1))
p <- p + coord_cartesian(ylim = c(0, 750000))
print(p)
                    
```

### Plot Public Health Facility HEF Level Outpatient Costs by Cost Type, Srvice, and Group
```{r ,echo=F, results='asis'}

p <- ggplot(data=subset(OutPCostBreakDown,Facility %in% PublicFac ),aes(x=variable,y=value))
p <- p + geom_point(shape=95,fill="Black",
                    ## position=position_jitter(w=.25,h=0),
                    size=10,
                    alpha=.2)
p <- p + facet_grid(Group~Facility)
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1))
p <- p + scale_y_continuous(name="Cost in LAK",labels=comma)
p <- p + scale_x_discrete("Cost Type")
p <- p + stat_summary(fun.data = "mean_cl_boot", colour = "red")
p <- p + labs(title="Costs by Facility, Cotst Type, and Insurance Group")
print(p)

p <- p + coord_cartesian(ylim = c(0, 150000))
print(p)

```

## InPatient

### Check Number of In Patient Records
```{r,results='html'}

##Check the total number of InPatient Events
length(InPat$Q)


##Check the total number of InPatient Events
sapply(InPatGroups,sum)

```

### Plot Inpatient Totals By Facility
```{r ,echo=F, results='asis'}


p <- ggplot(data=InPat,aes(x=Facility,y=Total))
p <- p + geom_point(shape=95,fill="Black",
                    size=10,
                    alpha=.2)
p <- p + facet_grid(Group~.)
p <- p + stat_summary(fun.data = "mean_cl_boot", colour = "red")
print(p)

p <- p + coord_cartesian(ylim = c(0, 2000000))
print(p)

```

### Plot Inpatient Totals By Facility with group
```{r ,echo=F, results='asis'}

p <- p + facet_grid(Group~.)
print(p)

p <- p + coord_cartesian(ylim = c(0, 50000))
print(p)

```

### Plot Inpatient Costs by Cost Type, Srvice, and Group
```{r ,echo=F, results='asis'}

InPCostBreakDown <-  melt(data=InPat[,c("Medical_Fee","Medicine","Others","Transport","Total","Serial","Facility","Group")],id.vars=c("Serial","Facility","Group"))
InPCostBreakDown <- subset(InPCostBreakDown,!is.na(value))

p <- ggplot(data=InPCostBreakDown)
p <- p + geom_point(aes(x=variable,y=value))
p <- p + facet_grid(Group~Facility)
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1))
p <- p + coord_cartesian(ylim = c(0, 750000))
print(p)
                    
```

### Plot Public Health Facility HEF Level Inpatient Costs by Cost Type, Srvice, and Group
```{r ,echo=F, results='asis'}

p <- ggplot(data=subset(InPCostBreakDown,Facility %in% PublicFac ),aes(x=variable,y=value))
p <- p + geom_point(shape=95,fill="Black",
                    ## position=position_jitter(w=.25,h=0),
                    size=10,
                    alpha=.2)
p <- p + stat_summary(fun.data = "mean_cl_boot", colour = "red")
p <- p + facet_grid(Facility~Group)
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1))
p <- p + scale_y_continuous(name="Cost in LAK",labels=comma)
p <- p + scale_x_discrete("Cost Type")
p <- p + labs(title="Costs by Facility, Cotst Type, and Insurance Group")
print(p)

p <- p + coord_cartesian(ylim = c(0, 500000))
print(p)

```

## Model
```{r,echo=F,results='asis'}

InPat$ModelID <-factor( paste(InPat$Group,InPat$Facility))
ModelMeans <- sapply(levels(InPat$ModelID),function(M){mean(subset(InPat,ModelID==M)[,"Total"])})
InPat$ModelID <-factor(InPat$ModelID,levels=levels(InPat$ModelID)[order(ModelMeans)])

p <- ggplot(data=InPat,aes(x=ModelID,y=Total))
p <- p + geom_point(shape=95,size=10,alpha=.1,na.rm=T)
p <- p + stat_summary(fun.data = "mean_cl_boot", colour = "red")
p <- p + stat_summary(fun.y = median, colour="blue",geom="point")
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(p)

p <- p + coord_cartesian(ylim = c(0, 5000000))
print(p)

p <- p + coord_cartesian(ylim = c(0, 50000))
print(p)

```

###OOP
```{r}

sapply(InPatGroups,function(G){
  sapply(levels(InPat$Facility),function(F) {
    mean(subset(InPat[G,],Facility==F)[,"Total"])
  })})



InPat$OOP <- InPat$Total > median(subset(InPat,Facility=="PH")$Total)
mylogit <- glm(OOP ~ Age +
                 Group +
                 NumIllnesses +
                 WPCA.NPeople +
                 WPCA.Sex +
                 WPCA.Lit1 +                                 
                 WPCA.Lit2 +                                 
                 WPCA.NCH  +                                
                 WPCA.NAdult +                                
                 WPCA.House +                              
                 WPCA.Roof +                               
                 WPCA.TV  +                                
                 WPCA.Vid  +                                 
                 WPCA.Bike  +                                
                 WPCA.Moto   +                               
                 WPCA.Tractor +                              
                 WPCA.Toilet  +                             
                 WPCA.Energy  +                             
                 WPCA.Cereals +                             
                 WPCA.Shop    +                             
                 WPCA.NChic   +                             
                 WPCA.NPig    +                             
                 WPCA.NCattel+
                 WPCA.Cash   ,
               data = subset(InPat,Facility=="PH"), family = "binomial")


summary(mylogit)
Pr <-predict(mylogit,type="response")
qplot(Pr)

P <- cbind.data.frame(Pr = Pr[order(Pr)],
                      OOP=as.numeric(subset(InPat,Facility=="PH")$OOP[order(Pr)]),
                      Ord=order(subset(InPat,Facility=="PH")$Total[order(Pr)])/length(subset(InPat,Facility=="PH")$OOP)
                      )
p <- ggplot(data=P,aes(x=1:length(Pr)))
p <- p + geom_point(aes(y=Pr),color="Blue")
p <- p + geom_point(aes(y=OOP),color="Red")
p <- p + geom_point(aes(y=Ord),color="Green")
print(p)

p <- p + coord_cartesian(xlim = c(0, 50))

c("Group","Gender","Age","NumIllnesses","Marital_Status","WPCA.NPeople","WPCA.Sex","WPCA.Lit1","WPCA.Lit2","WPCA.NCH","WPCA.NAdult","WPCA.House","WPCA.Roof","WPCA.TV","WPCA.Vid","WPCA.Bike","WPCA.Moto","WPCA.Tractor","WPCA.Toilet","WPCA.Energy","WPCA.Cereals","WPCA.Cash","WPCA.Shop","WPCA.NChic","WPCA.NPig","WPCA.NCattel")
ggpairs(InPat[predict(mylogit)<.65,c("Group","Age","NumIllnesses")])
      ## "WPCA.NPeople","WPCA.Sex","WPCA.Lit1","WPCA.Lit2","WPCA.NCH","WPCA.NAdult","WPCA.House","WPCA.Roof","WPCA.TV","WPCA.Vid","WPCA.Bike","WPCA.Moto","WPCA.Tractor","WPCA.Toilet","WPCA.Energy","WPCA.Cereals","WPCA.Cash","WPCA.Shop","WPCA.NChic","WPCA.NPig","WPCA.NCattel")])



plot(exp(predict(mylogit,InPat[order(InPat$Total),])))
plot(InPat[order(InPat$Total),"Total"]==0,color="Blue",add=T)

```




#catastrophic
```{r,echo=F,results='asis'}

all <- c("1_Total_cost_Overall_average","2_Total_cost_Overall_average","3_Total_cost_Overall_average")

V1 <- !is.na(AllResp[,"1_Indiv"])
V2 <- !is.na(AllResp[,"2_Indiv"])
V3 <- !is.na(AllResp[,"3_Indiv"])


CatTab <- rbind(NOutP=sapply(lgroups,function(G){sum(V1[G])}),
                OutP_G500K=sapply(lgroups,function(G){sum(AllResp[V1&G,"1_Total_cost_Overall_average"]>500000,na.rm=T)}),
                OutP_G1M=sapply(lgroups,function(G){sum(AllResp[V1&G,"1_Total_cost_Overall_average"]>1000000,na.rm=T)}),
                OutP_20Percent=sapply(lgroups,function(G){sum(AllResp[V1&G,"1_Total_cost_Overall_average"]>(.2*lps[V1&G,"HH_Cash_income"]),na.rm=T)}),
                NInP1=sapply(lgroups,function(G){sum(V2[G])}),
                InP1G_G500K=sapply(lgroups,function(G){sum(AllResp[V2&G,"2_Total_cost_Overall_average"]>500000,na.rm=T)}),
                InP1_G1M=sapply(lgroups,function(G){sum(AllResp[V2&G,"2_Total_cost_Overall_average"]>1000000,na.rm=T)}),
                InP1_20Percent=sapply(lgroups,function(G){sum(AllResp[V2&G,"2_Total_cost_Overall_average"]>(.2*lps[V2&G,"HH_Cash_income"]),na.rm=T)}),
                NInP2=sapply(lgroups,function(G){sum(V3[G])}),
                InP2_G500K=sapply(lgroups,function(G){sum(AllResp[V3&G,"3_Total_cost_Overall_average"]>500000,na.rm=T)}),
                InP2_G1M=sapply(lgroups,function(G){sum(AllResp[V3&G,"3_Total_cost_Overall_average"]>1000000,na.rm=T)}),
                InP2_20Percent=sapply(lgroups,function(G){sum(AllResp[V3&G,"3_Total_cost_Overall_average"]>(.2*lps[V3&G,"HH_Cash_income"]),na.rm=T)}),
                NTot=sapply(lgroups,function(G){sum(V3[G]|V2[G]|V1[G])}),
                Tot_G500K=sapply(lgroups,function(G){sum(rowSums(AllResp[G,all],na.rm=T)>500000,na.rm=T)}),
                Tot_G1M=sapply(lgroups,function(G){sum(rowSums(AllResp[G,all],na.rm=T)>2000000,na.rm=T)}),
                Tot_20Percent=sapply(lgroups,function(G){sum(rowSums(AllResp[G,all],na.rm=T)>(.2*lps[G,"HH_Cash_income"]),na.rm=T)}))

print(xtable(CatTab,"CatastrophicExpenditure"),type='html')

c("1_Total_cost_Overall_average","2_Total_cost_Overall_average","3_Total_cost_Overall_average")
V1 <- !is.na(AllResp[,"1_Indiv"])
sapply(lgroups,function(G){sum(AllResp[V1&G,"1_Total_cost_Overall_average"]>500000,na.rm=T)})


```





```{r,echo=F,results='hide',warning=F}

CareCenterAgr <- function(X) {
  c(N=sum(!is.na(X)),
    N0=sum(X==0,na.rm=T),
    Max=max(X,na.rm=T),
    Mean=mean(X,na.rm=T),
    Median=median(X,na.rm=T)
    )
}

MeansByGroup <- aggregate(OutPatCostTable[,c("Overall_average","Medical_Fee","Medicine","Transport")],list(Cat1=OutPatCostTable$CareCenter,Cat2=OutPatCostTable$Group),CareCenterAgr)
MeansByGroup <- cbind(MeansByGroup[1],MeansByGroup[2],as.matrix(MeansByGroup[3:6]))
#write.csv(MeansByGroup,"./output/OutPatienCostDetails.csv")

MeansForAll <- aggregate(OutPatCostTable[,c("Overall_average","Medical_Fee","Medicine","Transport")],list(Cat1=OutPatCostTable$CareCenter ),CareCenterAgr)
dim(MeansForAll)
                                        #write.csv(MeansForAll,"./output/OutPatienCostDetails.csv")
MeansForAll <- cbind(MeansForAll[1],
                     Cat2=rep("All",length(MeansForAll[,1])),
                     as.matrix(MeansForAll[2:5]))
head(MeansForAll)
dim(MeansForAll)
dim(MeansByGroup)

write.csv(rbind(MeansForAll,MeansByGroup),file="./output/OutpatientCostMeansDetails.csv")

########################################

MeansByGroup <- aggregate(InPatCostTable[,c("Overall_average","Medical_Fee","Medicine","Transport")],list(Cat1=InPatCostTable$CareCenter,Cat2=InPatCostTable$Group),CareCenterAgr)
MeansByGroup <- cbind(MeansByGroup[1],MeansByGroup[2],as.matrix(MeansByGroup[3:6]))
#write.csv(MeansByGroup,"./output/InPatienCostDetails.csv")

MeansForAll <- aggregate(InPatCostTable[,c("Overall_average","Medical_Fee","Medicine","Transport")],list(Cat1=InPatCostTable$CareCenter ),CareCenterAgr)
dim(MeansForAll)
                                        #write.csv(MeansForAll,"./output/InPatienCostDetails.csv")
MeansForAll <- cbind(MeansForAll[1],
                     Cat2=rep("All",length(MeansForAll[,1])),
                     as.matrix(MeansForAll[2:5]))
head(MeansForAll)
dim(MeansForAll)
dim(MeansByGroup)

write.csv(rbind(MeansForAll,MeansByGroup),file="./output/InpatientCostMeansDetails.csv")



NIll <- aggregate(OutPatCostTable$NumIllnesses,list(Cat1=OutPatCostTable$CareCenter,Cat2=OutPatCostTable$Group),
                  function(X){
                    c(N=length(X),NFound=sum(!is.na(X)),NSick=mean(X,na.rm=T))
                  })

UsageProfileByGroup <- cbind(aggregate(OutPatCostTable[,c("Age","Overall_average")],list(Cat1=OutPatCostTable$CareCenter,Cat2=OutPatCostTable$Group),mean),
                      NIll[3])

UsageProfileAll <- cbind(aggregate(OutPatCostTable[,c("Age","Overall_average")],list(Cat1=OutPatCostTable$CareCenter),mean),      
       aggregate(OutPatCostTable$NumIllnesses,list(Cat1=OutPatCostTable$CareCenter),
                  function(X){
                    c(N=length(X),NFound=sum(!is.na(X)),NSick=mean(X,na.rm=T))
                  })[2]
      )

```
